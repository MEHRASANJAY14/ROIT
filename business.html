const API_URL="https://script.google.com/macros/s/AKfycbzTaMnM5Me3GitJAa3ztT8wSne5dcr__uegB-6qgwnTQRgi6hsUc_iI1i9ri6pYfrHfOw/exec";

function growthClass(value,isNPA){

  if(value === null || value === undefined) return "";

  let cleaned = value.toString()
      .replace(/âˆ’/g,"-")
      .replace(/,/g,"")
      .replace("%","")
      .trim();

  let v = parseFloat(cleaned);
  if(isNaN(v)) return "";

  if(isNPA){
      return v < 0 ? "positive" : (v > 0 ? "negative" : "");
  }else{
      return v > 0 ? "positive" : (v < 0 ? "negative" : "");
  }
}

function formatHeader(text){
  if(!text) return "";
  text=text.trim();

  if(text.includes("Last Month")){
    let d=text.replace("Last Month","").trim();
    return "Last<br>Month<br><span class='header-date'>"+d+"</span>";
  }
  if(text.includes("Previous as on")){
    let d=text.replace("Previous as on","").trim();
    return "Previous<br>as on<br><span class='header-date'>"+d+"</span>";
  }
  if(text.includes("Current as on")){
    let d=text.replace("Current as on","").trim();
    return "Current<br>as on<br><span class='header-date'>"+d+"</span>";
  }
  return "<span class='header-date'>"+text+"</span>";
}

function loadBranches(){
  fetch(API_URL+"?type=branches")
  .then(res=>res.json())
  .then(data=>{
    const select=document.getElementById("branch");
    select.innerHTML='<option value="">Select Branch</option>';
    data.forEach(r=>{
      let o=document.createElement("option");
      o.value=r[0];
      o.text=r[0]+" - "+r[1];
      select.appendChild(o);
    });
  })
  .catch(err=>{
    console.log("Branch Load Error:",err);
  });
}

function renderSection(title,start,row,headers,isNPA){

  const h=headers.slice(start,start+7);
  const d=row.slice(start,start+7);

  return `
  <div class="section">
    <div class="section-title">${title}</div>
    <div class="table-wrapper">
      <table>
        <tr>
          <th>${formatHeader(h[0])}</th>
          <th>${formatHeader(h[1])}</th>
          <th>${formatHeader(h[2])}</th>
          <th>${formatHeader(h[3])}</th>
          <th>FTD</th>
          <th>MTD</th>
          <th>YTD</th>
        </tr>
        <tr>
          ${d.map((v,i)=>
            `<td class="${i>=4 ? growthClass(v,isNPA) : ''}">${v}</td>`
          ).join("")}
        </tr>
      </table>
    </div>
  </div>`;
}

document.getElementById("branch").addEventListener("change",function(){

  if(!this.value) return;

  fetch(API_URL+"?type=branchData&solid="+this.value)
  .then(res=>res.json())
  .then(result=>{

    const row=result.row;
    const headers=result.headers;

    document.getElementById("branchInfo").innerHTML=
      `<div class="branch-card">
        Branch Code: ${row[0]} | Branch Name: ${row[1]}
      </div>`;

    document.getElementById("summary").innerHTML=
      `<div class="summary">
        <div class="summary-card"><h4>Advance</h4><h2>${row[5]}</h2></div>
        <div class="summary-card"><h4>NPA</h4><h2>${row[12]}</h2></div>
        <div class="summary-card"><h4>Deposit</h4><h2>${row[19]}</h2></div>
        <div class="summary-card"><h4>CASA</h4><h2>${row[26]}</h2></div>
      </div>`;

    let html="";
    html+=renderSection("ADVANCE",3,row,headers,false);
    html+=renderSection("NPA",10,row,headers,true);
    html+=renderSection("DEPOSIT",17,row,headers,false);
    html+=renderSection("CASA",24,row,headers,false);

    document.getElementById("dashboard").innerHTML=html;

  })
  .catch(err=>{
    console.log("Branch Data Error:",err);
  });

});

loadBranches();
